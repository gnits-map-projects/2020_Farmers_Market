{"version":3,"file":"Collapse.umd.js","sources":["../src/components/collapse/Collapse.jsx"],"sourcesContent":["/* eslint-env browser */\n\n/**\n * All debug logs are removed on build\n */\n\nimport \"./collapse.css\";\nimport React, {\n  useState,\n  useEffect,\n  useRef,\n  useCallback,\n  useReducer\n} from \"react\";\nimport debugLog from \"./debugLog\";\n\n// using let instead of const,\n// experimenting with ES2015 bundle which gets a bit smaller when using let over const.\nlet COLLAPSED = \"collapsed\";\nlet COLLAPSING = \"collapsing\";\nlet EXPANDING = \"expanding\";\nlet EXPANDED = \"expanded\";\n\nlet defaultClassName = \"collapse-css-transition\";\nlet defaultElementType = \"div\";\nlet defaultCollapseHeight = \"0px\";\n\n/**\n *\n * @param {function} callback\n */\nfunction nextFrame(callback) {\n  requestAnimationFrame(function() {\n    //setTimeout(callback, 0); // NOT used because can be jumpy if click-spamming.\n    requestAnimationFrame(callback); // This is used.\n  });\n}\n\nfunction Collapse({\n  children,\n  transition,\n  style,\n  render,\n  elementType = defaultElementType,\n  isOpen,\n  collapseHeight = defaultCollapseHeight,\n  onInit,\n  onChange,\n  className = defaultClassName,\n  addState,\n  noAnim,\n  overflowOnExpanded,\n  ...rest\n}) {\n  let getCollapsedVisibility = () => (collapseHeight === \"0px\" ? \"hidden\" : \"\");\n\n  const [__, forceUpdate] = useReducer(_ => _ + 1, 0);\n\n  let elementRef = useRef();\n  let [callbackTick, setCallbackTick] = useState(0);\n\n  // Avoiding setState to control when stuff are updated.\n  // Might not be needed.\n  let state = useRef({\n    collapse: isOpen ? EXPANDED : COLLAPSED,\n    style: {\n      height: isOpen ? \"\" : collapseHeight,\n      visibility: isOpen ? \"\" : getCollapsedVisibility()\n    }\n  }).current;\n\n  useEffect(() => {\n    // Invoke callback when data are updated, use Effect to sync state.\n    callbackTick && onCallback(onChange);\n  }, [callbackTick]);\n\n  /**\n   *\n   * @param {function} callback\n   */\n  let onCallback = (callback, params = {}) => {\n    if (callback) {\n      debugLog(\"onCallback \" + callback.name);\n      callback({ state: state.collapse, style: state.style, ...params });\n    }\n  };\n\n  function setCollapsed() {\n    if (!elementRef.current) return; // might be redundant\n\n    // Update state\n    state.collapse = COLLAPSED;\n\n    debugLog(\"setCollapsed\");\n\n    state.style = {\n      height: collapseHeight,\n      visibility: getCollapsedVisibility()\n    };\n    forceUpdate();\n\n    setTimeout(() => setCallbackTick(Date.now), 0); // callback and re-render\n  }\n\n  function setCollapsing() {\n    if (!elementRef.current) return; // might be redundant\n\n    if (noAnim) {\n      return setCollapsed();\n    }\n\n    // Update state\n    state.collapse = COLLAPSING;\n\n    debugLog(\"setCollapsing\");\n\n    state.style = {\n      height: getElementHeight(),\n      visibility: \"\"\n    };\n    forceUpdate();\n\n    nextFrame(() => {\n      if (!elementRef.current) return;\n      if (state.collapse !== COLLAPSING) return;\n\n      state.style = {\n        height: collapseHeight,\n        visibility: \"\"\n      };\n      //forceUpdate();\n\n      setCallbackTick(Date.now); // callback and re-render\n    });\n  }\n\n  function setExpanding() {\n    if (!elementRef.current) return; // might be redundant\n\n    if (noAnim) {\n      return setExpanded();\n    }\n\n    // Updatetate\n    state.collapse = EXPANDING;\n\n    debugLog(\"setExpanding\");\n\n    nextFrame(() => {\n      if (!elementRef.current) return; // might be redundant\n      if (state.collapse !== EXPANDING) return;\n\n      state.style = {\n        height: getElementHeight(),\n        visibility: \"\"\n      };\n      // forceUpdate();\n\n      setCallbackTick(Date.now); // callback and re-render\n    });\n  }\n\n  function setExpanded() {\n    if (!elementRef.current) return; // might be redundant\n\n    // Update state\n    state.collapse = EXPANDED;\n\n    debugLog(\"setExpanded\");\n\n    state.style = {\n      height: \"\",\n      visibility: \"\"\n    };\n    forceUpdate();\n\n    setTimeout(() => setCallbackTick(Date.now), 0); // callback and re-render\n  }\n\n  function getElementHeight() {\n    // @ts-ignore\n    return `${elementRef.current.scrollHeight}px`;\n  }\n\n  function onTransitionEnd({ target, propertyName }) {\n    if (target === elementRef.current && propertyName === \"height\") {\n      let styleHeight = target.style.height;\n\n      debugLog(\"onTransitionEnd\", state.collapse, propertyName, styleHeight);\n\n      switch (state.collapse) {\n        case EXPANDING:\n          if (styleHeight === \"\" || styleHeight === collapseHeight)\n            // This is stale, a newer event has happened before this could execute\n            console.warn(\n              `onTransitionEnd height unexpected ${styleHeight}`,\n              \"ignore setExpanded\"\n            );\n          else setExpanded();\n          break;\n        case COLLAPSING:\n          if (styleHeight === \"\" || styleHeight !== collapseHeight)\n            // This is stale, a newer event has happened before this could execute\n            console.warn(\n              `onTransitionEnd height unexpected ${styleHeight}`,\n              \"ignore setCollapsed\"\n            );\n          else setCollapsed();\n          break;\n        default:\n          console.warn(\"Ignored in onTransitionEnd\", state.collapse);\n      }\n    }\n  }\n\n  // getDerivedStateFromProps\n  let didOpen = state.collapse === EXPANDED || state.collapse === EXPANDING;\n\n  if (!didOpen && isOpen) setExpanding();\n\n  if (didOpen && !isOpen) setCollapsing();\n  // END getDerivedStateFromProps\n\n  let overflow =\n    state.collapse === EXPANDED && overflowOnExpanded ? \"\" : \"hidden\";\n\n  let computedStyle = {\n    overflow,\n    transition,\n    ...style,\n    ...state.style\n  };\n  let ElementType = elementType;\n\n  let callbackRef = useCallback(\n    node => {\n      if (node) {\n        elementRef.current = node;\n        onCallback(onInit, { node });\n        debugLog(\"callback ref\");\n      }\n    },\n    [elementType]\n  );\n\n  let collapseClassName = addState\n    ? `${className} --c-${state.collapse}`\n    : className;\n\n  debugLog(\"Render\");\n\n  return (\n    <ElementType\n      ref={callbackRef}\n      style={computedStyle}\n      onTransitionEnd={onTransitionEnd}\n      className={collapseClassName}\n      {...rest}\n    >\n      {typeof children === \"function\"\n        ? children(state.collapse)\n        : typeof render === \"function\"\n        ? render(state.collapse)\n        : children}\n    </ElementType>\n  );\n}\n\nexport default Collapse;\n"],"names":["COLLAPSED","COLLAPSING","EXPANDING","EXPANDED","defaultClassName","defaultElementType","defaultCollapseHeight","nextFrame","callback","requestAnimationFrame","children","transition","style","render","elementType","isOpen","collapseHeight","onInit","onChange","className","addState","noAnim","overflowOnExpanded","rest","getCollapsedVisibility","useReducer","_","forceUpdate","elementRef","useRef","useState","callbackTick","setCallbackTick","state","collapse","height","visibility","current","useEffect","onCallback","params","name","setCollapsed","setTimeout","Date","now","setExpanded","getElementHeight","scrollHeight","didOpen","setExpanding","setCollapsing","computedStyle","overflow","ElementType","callbackRef","useCallback","node","collapseClassName","React","ref","onTransitionEnd","target","propertyName","styleHeight"],"mappings":"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"}